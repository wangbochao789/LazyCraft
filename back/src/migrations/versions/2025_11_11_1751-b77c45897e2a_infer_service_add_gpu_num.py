# Copyright (c) 2025 SenseTime. All Rights Reserved.
# Author: LazyLLM Team,  https://github.com/LazyAGI/LazyLLM
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""
æ•°æ®åº“è¿ç§»: infer service add  gpu num 

==========================================
è‡ªåŠ¨ç”Ÿæˆçš„æ•°æ®åº“è¿ç§»æ–‡ä»¶
==========================================

è¿ç§»ä¿¡æ¯:
---------
- ä¿®è®¢ç‰ˆæœ¬: b77c45897e2a
- åŸºäºç‰ˆæœ¬: def28d16b22a
- åˆ›å»ºæ—¶é—´: 2025-11-11 17:51:02.829256
- è¿ç§»æè¿°: infer service add  gpu num 

é‡è¦è¯´æ˜:
---------
âš ï¸  åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰ï¼Œè¯·åŠ¡å¿…ï¼š
   1. åœ¨æµ‹è¯•ç¯å¢ƒä¸­å®Œæ•´éªŒè¯æ‰€æœ‰è¿ç§»æ“ä½œ
   2. å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
   3. ç¡®è®¤è¿ç§»æ“ä½œçš„å¯é€†æ€§
   4. è¯„ä¼°å¤§è¡¨æ“ä½œçš„æ€§èƒ½å½±å“
   5. å‡†å¤‡å›æ»šè®¡åˆ’

ğŸ“‹ ä½¿ç”¨æ–¹æ³•:
   - å‡çº§åˆ°æ­¤ç‰ˆæœ¬: flask db upgrade
   - é™çº§åˆ°ä¸Šä¸€ç‰ˆæœ¬: flask db downgrade
   - æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: flask db current
   - æŸ¥çœ‹è¿ç§»å†å²: flask db history

ğŸ” å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»æ•°æ®åº“ç®¡ç†å‘˜æˆ–å¼€å‘å›¢é˜Ÿã€‚
"""

# =============================================================================
# å¯¼å…¥å¿…è¦çš„æ¨¡å—
# =============================================================================

from alembic import op
import sqlalchemy as sa
from models import StringUUID

# å¯¼å…¥å…¶ä»–å¿…è¦çš„æ¨¡å—ï¼ˆç”± Alembic è‡ªåŠ¨ç”Ÿæˆï¼‰
from sqlalchemy.dialects import mysql

# =============================================================================
# è¿ç§»ç‰ˆæœ¬æ ‡è¯†ç¬¦
# =============================================================================

# è¿™äº›æ ‡è¯†ç¬¦ç”± Alembic è‡ªåŠ¨ç®¡ç†ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
revision = 'b77c45897e2a'
down_revision = 'def28d16b22a'
branch_labels = None
depends_on = None


# =============================================================================
# æ•°æ®åº“å‡çº§æ“ä½œ
# =============================================================================

def upgrade():
    """
    æ‰§è¡Œæ•°æ®åº“å‡çº§æ“ä½œã€‚
    
    æ­¤å‡½æ•°åŒ…å«å°†æ•°æ®åº“ä»å‰ä¸€ä¸ªç‰ˆæœ¬å‡çº§åˆ°å½“å‰ç‰ˆæœ¬æ‰€éœ€çš„æ‰€æœ‰æ“ä½œã€‚
    
    æ“ä½œç±»å‹å¯èƒ½åŒ…æ‹¬ï¼š
    - åˆ›å»ºæ–°è¡¨ (op.create_table)
    - åˆ é™¤è¡¨ (op.drop_table)
    - æ·»åŠ åˆ— (op.add_column)
    - åˆ é™¤åˆ— (op.drop_column)
    - ä¿®æ”¹åˆ— (op.alter_column)
    - åˆ›å»ºç´¢å¼• (op.create_index)
    - åˆ é™¤ç´¢å¼• (op.drop_index)
    - åˆ›å»ºå¤–é”®çº¦æŸ (op.create_foreign_key)
    - åˆ é™¤å¤–é”®çº¦æŸ (op.drop_constraint)
    - æ•°æ®è¿ç§»æ“ä½œ
    
    âš ï¸  å®‰å…¨æé†’ï¼š
       - å¤§è¡¨æ“ä½œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·åœ¨ç»´æŠ¤çª—å£å†…æ‰§è¡Œ
       - æ·»åŠ éç©ºåˆ—æ—¶ï¼Œç¡®ä¿å·²æœ‰æ•°æ®çš„å¤„ç†ç­–ç•¥
       - åˆ é™¤åˆ—æˆ–è¡¨å‰ï¼Œç¡®è®¤æ•°æ®å·²æ­£ç¡®å¤‡ä»½æˆ–è¿ç§»
       - ç´¢å¼•æ“ä½œå¯èƒ½ä¼šé”å®šè¡¨ï¼Œæ³¨æ„å¯¹ä¸šåŠ¡çš„å½±å“
    
    ğŸ“ æ‰§è¡Œè®°å½•ï¼š
       æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•åœ¨ alembic_version è¡¨ä¸­ï¼Œä¾¿äºè¿½è¸ªè¿ç§»å†å²ã€‚
    """
    # =========================================================================
    # åœ¨æ­¤å¤„æ·»åŠ å‡çº§æ“ä½œ
    # =========================================================================
    
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('celery_taskmeta', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('task_id'))

    op.drop_table('celery_taskmeta')
    with op.batch_alter_table('celery_tasksetmeta', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('taskset_id'))

    op.drop_table('celery_tasksetmeta')
    with op.batch_alter_table('infer_model_services', schema=None) as batch_op:
        batch_op.add_column(sa.Column('model_num_gpus', sa.Integer(), nullable=False))

    # ### end Alembic commands ###


# =============================================================================
# æ•°æ®åº“é™çº§æ“ä½œ
# =============================================================================

def downgrade():
    """
    æ‰§è¡Œæ•°æ®åº“é™çº§æ“ä½œã€‚
    
    æ­¤å‡½æ•°åŒ…å«å°†æ•°æ®åº“ä»å½“å‰ç‰ˆæœ¬å›æ»šåˆ°å‰ä¸€ä¸ªç‰ˆæœ¬æ‰€éœ€çš„æ‰€æœ‰æ“ä½œã€‚
    è¿™äº›æ“ä½œåº”è¯¥èƒ½å¤Ÿå®Œå…¨æ’¤é”€ upgrade() å‡½æ•°ä¸­çš„æ‰€æœ‰å˜æ›´ã€‚
    
    é™çº§æ“ä½œç‰¹ç‚¹ï¼š
    - å¿…é¡»ä¸å‡çº§æ“ä½œå®Œå…¨å¯¹åº”
    - æ“ä½œé¡ºåºé€šå¸¸ä¸å‡çº§æ“ä½œç›¸å
    - éœ€è¦è€ƒè™‘æ•°æ®ä¸¢å¤±çš„é£é™©
    
    âš ï¸  é‡è¦è­¦å‘Šï¼š
       - é™çº§å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œç‰¹åˆ«æ˜¯åˆ é™¤åˆ—æˆ–è¡¨çš„æ“ä½œ
       - æŸäº›æ“ä½œå¯èƒ½ä¸å¯é€†ï¼Œå¦‚æ•°æ®ç±»å‹è½¬æ¢
       - æ‰§è¡Œå‰å¿…é¡»ç¡®ä¿æ•°æ®å·²å¤‡ä»½
       - ä¸æ˜¯æ‰€æœ‰è¿ç§»éƒ½æ”¯æŒå®‰å…¨çš„é™çº§æ“ä½œ
    
    ğŸ”„ å¸¸è§é™çº§æ“ä½œï¼š
       - å¦‚æœå‡çº§æ—¶åˆ›å»ºäº†è¡¨ï¼Œé™çº§æ—¶åº”åˆ é™¤è¡¨
       - å¦‚æœå‡çº§æ—¶æ·»åŠ äº†åˆ—ï¼Œé™çº§æ—¶åº”åˆ é™¤åˆ—
       - å¦‚æœå‡çº§æ—¶ä¿®æ”¹äº†åˆ—ï¼Œé™çº§æ—¶åº”æ¢å¤åŸå§‹å®šä¹‰
       - å¦‚æœå‡çº§æ—¶åˆ›å»ºäº†ç´¢å¼•ï¼Œé™çº§æ—¶åº”åˆ é™¤ç´¢å¼•
    
    ğŸ’¡ æœ€ä½³å®è·µï¼š
       - ä¼˜å…ˆè®¾è®¡å¯é€†çš„è¿ç§»æ“ä½œ
       - å¯¹äºä¸å¯é€†æ“ä½œï¼Œåœ¨æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜
       - è€ƒè™‘ä½¿ç”¨æ•°æ®è¿ç§»æ¥ä¿æŠ¤é‡è¦æ•°æ®
    """
    # =========================================================================
    # åœ¨æ­¤å¤„æ·»åŠ é™çº§æ“ä½œ
    # =========================================================================
    
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('infer_model_services', schema=None) as batch_op:
        batch_op.drop_column('model_num_gpus')

    op.create_table('celery_tasksetmeta',
    sa.Column('id', mysql.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('taskset_id', mysql.VARCHAR(length=155), nullable=True),
    sa.Column('result', sa.BLOB(), nullable=True),
    sa.Column('date_done', mysql.DATETIME(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    mysql_collate='utf8mb4_bin',
    mysql_default_charset='utf8mb4',
    mysql_engine='InnoDB'
    )
    with op.batch_alter_table('celery_tasksetmeta', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('taskset_id'), ['taskset_id'], unique=True)

    op.create_table('celery_taskmeta',
    sa.Column('id', mysql.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('task_id', mysql.VARCHAR(length=155), nullable=True),
    sa.Column('status', mysql.VARCHAR(length=50), nullable=True),
    sa.Column('result', sa.BLOB(), nullable=True),
    sa.Column('date_done', mysql.DATETIME(), nullable=True),
    sa.Column('traceback', mysql.TEXT(), nullable=True),
    sa.Column('name', mysql.VARCHAR(length=155), nullable=True),
    sa.Column('args', sa.BLOB(), nullable=True),
    sa.Column('kwargs', sa.BLOB(), nullable=True),
    sa.Column('worker', mysql.VARCHAR(length=155), nullable=True),
    sa.Column('retries', mysql.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('queue', mysql.VARCHAR(length=155), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    mysql_collate='utf8mb4_bin',
    mysql_default_charset='utf8mb4',
    mysql_engine='InnoDB'
    )
    with op.batch_alter_table('celery_taskmeta', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('task_id'), ['task_id'], unique=True)

    # ### end Alembic commands ###


# =============================================================================
# è¿ç§»æ“ä½œç¤ºä¾‹å’Œå‚è€ƒ
# =============================================================================

"""
å¸¸ç”¨è¿ç§»æ“ä½œç¤ºä¾‹ï¼š

1. åˆ›å»ºè¡¨ï¼š
   op.create_table(
       'account',
       sa.Column('id', sa.String(36), primary_key=True),
       sa.Column('name', sa.String(255), nullable=False),
       sa.Column('email', sa.String(255), nullable=False, unique=True),
       sa.Column('created_at', sa.DateTime(), nullable=False),
   )

2. åˆ é™¤è¡¨ï¼š
   op.drop_table('account')

3. æ·»åŠ åˆ—ï¼š
   op.add_column('account', sa.Column('phone', sa.String(20), nullable=True))

4. åˆ é™¤åˆ—ï¼š
   op.drop_column('account', 'phone')

5. ä¿®æ”¹åˆ—ï¼š
   op.alter_column('account', 'name', type_=sa.String(500))

6. åˆ›å»ºç´¢å¼•ï¼š
   op.create_index('idx_account_email', 'account', ['email'])

7. åˆ é™¤ç´¢å¼•ï¼š
   op.drop_index('idx_account_email', 'account')

8. åˆ›å»ºå¤–é”®ï¼š
   op.create_foreign_key(
       'fk_user_account_id', 'user', 'account',
       ['account_id'], ['id']
   )

9. åˆ é™¤å¤–é”®ï¼š
   op.drop_constraint('fk_user_account_id', 'user', type_='foreignkey')

10. æ•°æ®è¿ç§»ï¼š
    connection = op.get_bind()
    connection.execute(
        sa.text("UPDATE account SET status = 'active' WHERE status IS NULL")
    )
"""